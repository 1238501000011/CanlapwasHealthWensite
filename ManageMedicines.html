<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Hub Admin - Manage Medicines</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f4f7fb;
            color: #1f2937;
            line-height: 1.5;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: white;
            padding: 2.25rem 1.75rem;
            display: flex;
            flex-direction: column;
            gap: 2.25rem;
            box-shadow: 6px 0 20px rgba(15, 23, 42, 0.06);
        }

        .logo-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(15, 118, 110, 0.18);
            overflow: hidden;
        }
        
        .logo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .logo-text span:nth-child(1) {
            font-size: 1.05rem;
            font-weight: 700;
            color: #2563eb;
        }

        .logo-text span:nth-child(2) {
            font-size: 1.05rem;
            font-weight: 700;
            color: #0f766e;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.75rem 0.9rem;
            border-radius: 18px;
            font-weight: 600;
            color: #1e293b;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .nav-link svg {
            width: 18px;
            height: 18px;
            color: #1f2937;
            transition: color 0.3s ease;
        }

        .nav-link.active {
            background: linear-gradient(180deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            box-shadow: 0 12px 26px rgba(37, 99, 235, 0.28);
        }

        .nav-link.active svg {
            color: white;
        }

        .nav-link:hover {
            transform: translateX(6px);
            background: rgba(59, 130, 246, 0.08);
        }

        .nav-link:hover svg {
            color: #2563eb;
        }

        .back-link {
            margin-top: auto;
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #1f2937;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: #f8fafc;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
        }

        .back-link svg {
            width: 20px;
            height: 20px;
        }

        .back-link:hover {
            background: #eef2ff;
            transform: translateX(4px);
        }

        .main-content {
            flex: 1;
            padding: 2.75rem 3.25rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .content-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .content-title h1 {
            font-size: 3rem;
            font-weight: 800;
            color: #0f172a;
        }

        .content-title p {
            margin-top: 0.75rem;
            font-size: 1.05rem;
            color: #64748b;
        }

        .add-button {
            background: #1d4ed8;
            color: white;
            font-weight: 600;
            padding: 0.85rem 1.8rem;
            border: none;
            border-radius: 999px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 12px 30px rgba(37, 99, 235, 0.22);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .add-button svg {
            width: 18px;
            height: 18px;
        }

        .add-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 34px rgba(37, 99, 235, 0.3);
        }

        .search-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: white;
            padding: 0.85rem 1.1rem;
            border-radius: 999px;
            border: 1px solid #e2e8f0;
            box-shadow: inset 0 0 0 1px rgba(226, 232, 240, 0.4);
            max-width: 420px;
        }

        .search-bar svg {
            width: 20px;
            height: 20px;
            color: #94a3b8;
        }

        .search-bar input {
            border: none;
            flex: 1;
            font-size: 1rem;
            color: #0f172a;
            outline: none;
        }

        .medicines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .medicine-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.06);
            padding: 1.4rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .medicine-card.hidden {
            display: none;
        }

        .medicine-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .medicine-info {
            display: flex;
            align-items: center;
            gap: 0.85rem;
        }

        .medicine-icon {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background: rgba(37, 99, 235, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2563eb;
        }

        .medicine-icon svg {
            width: 20px;
            height: 20px;
        }

        .medicine-name {
            font-weight: 700;
            color: #111827;
        }

        .medicine-category {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .medicine-status {
            font-size: 0.78rem;
            font-weight: 600;
            padding: 0.3rem 0.75rem;
            border-radius: 999px;
        }

        .status-stock {
            background: #d1fae5;
            color: #047857;
        }

        .status-low {
            background: #fef3c7;
            color: #b45309;
        }

        .medicine-actions {
            display: flex;
            gap: 0.75rem;
        }

        .action-pill {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            padding: 0.4rem 0.6rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            font-weight: 600;
            font-size: 0.9rem;
            color: #0f172a;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-pill.delete {
            color: #dc2626;
        }

        .action-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
        }

        .action-pill svg {
            width: 16px;
            height: 16px;
        }

        .quantity {
            font-size: 0.9rem;
            color: #94a3b8;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid #e2e8f0;
            background: white;
            color: #475569;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover {
            background: #f1f5f9;
            transform: scale(1.1);
        }

        .quantity-value {
            min-width: 24px;
            text-align: center;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 100;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            padding: 2rem;
            box-shadow: 0 25px 50px rgba(15, 23, 42, 0.25);
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .modal h2 {
            font-size: 1.35rem;
            font-weight: 700;
            color: #0f172a;
        }

        .modal form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .form-group label {
            font-weight: 600;
            color: #0f172a;
        }

        .form-group input {
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 0.85rem 1rem;
            font-size: 0.95rem;
            color: #0f172a;
            outline: none;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
        }

        .modal-btn {
            flex: 1;
            border: none;
            border-radius: 999px;
            padding: 0.85rem 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.save {
            background: #1d4ed8;
            color: white;
        }

        .modal-btn.cancel {
            background: #edf2f7;
            color: #1f2937;
        }

        .hidden {
            display: none;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #1f2937;
            padding: 0.5rem;
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                padding: 2rem 1.5rem;
            }

            .medicines-table-container {
                overflow-x: auto;
            }
        }

        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 1.5rem 1rem;
                position: relative;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .sidebar-nav {
                display: none;
                flex-direction: column;
                gap: 0.75rem;
                margin-top: 1rem;
                width: 100%;
            }

            .sidebar-nav.active {
                display: flex;
            }

            .nav-link {
                width: 100%;
                justify-content: flex-start;
            }

            .back-link {
                margin-top: 1rem;
            }

            .main-content {
                padding: 1.5rem 1rem;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .content-header h1 {
                font-size: 1.75rem;
            }

            .medicines-table {
                font-size: 0.9rem;
            }

            .medicines-table th,
            .medicines-table td {
                padding: 0.75rem 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .action-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                padding: 1rem 0.75rem;
            }

            .logo-text span {
                font-size: 0.9rem;
            }

            .main-content {
                padding: 1rem 0.75rem;
            }

            .content-header h1 {
                font-size: 1.5rem;
            }

            .medicines-table {
                font-size: 0.85rem;
            }

            .medicines-table th,
            .medicines-table td {
                padding: 0.625rem 0.375rem;
            }

            .action-btn {
                padding: 0.4rem 0.625rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <button class="mobile-menu-toggle" id="adminMobileMenuToggle" aria-label="Toggle menu">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <div class="logo-badge">
                <div class="logo-circle">
                    <img src="Image/Logohub.png" alt="Health Hub Logo" onerror="this.style.display='none';">
                </div>
                <div class="logo-text">
                    <span>Health Hub</span>
                    <span>Admin</span>
                </div>
            </div>

            <nav class="sidebar-nav" id="adminSidebarNav">
                <a href="Admin.html" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 11.5L12 3l9 8.5" />
                        <path d="M5 10.5V21h5.5v-5.5H13V21h6v-10.5" />
                    </svg>
                    Dashboard
                </a>
                <a href="ManageSchedules.html" class="nav-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 7h16" />
                        <path d="M7 3v4" />
                        <path d="M17 3v4" />
                        <rect x="4" y="7" width="16" height="14" rx="2" />
                        <path d="M8 13h3" />
                        <path d="M13 16h3" />
                    </svg>
                    Manage Schedules
                </a>
                <a href="ManageMedicines.html" class="nav-link active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 3h12" />
                        <path d="M10 3v5l-4 7v3h12v-3l-4-7V3" />
                        <path d="M8 18h8" />
                    </svg>
                    Manage Medicines
                </a>
            </nav>

            <a href="Home.html" class="back-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H7" />
                    <path d="M12 7l-5 5 5 5" />
                </svg>
                Back to Website
            </a>
        </aside>

        <main class="main-content">
            <div class="content-header">
                <div class="content-title">
                    <h1>Manage Medicines</h1>
                    <p>Update inventory and stocks levels</p>
                </div>
                <button class="add-button" id="addMedicineBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14" />
                        <path d="M5 12h14" />
                    </svg>
                    Add Medicine
                </button>
            </div>

            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z" />
                </svg>
                <input type="text" id="searchInput" placeholder="Search Medicines....." aria-label="Search medicines">
            </div>

            <section class="medicines-grid" id="medicinesGrid"></section>
        </main>
    </div>

    <div class="modal-overlay hidden" id="medicineModal">
        <div class="modal">
            <h2 id="modalTitle">Add Medicine</h2>
            <form id="medicineForm">
                <input type="hidden" id="medicineId">
                <div class="form-group">
                    <label for="medicineName">Medicine Name</label>
                    <input type="text" id="medicineName" required placeholder="e.g. Paracetamol 500mg">
                </div>
                <div class="form-group">
                    <label for="medicineCategory">Category</label>
                    <input type="text" id="medicineCategory" required placeholder="e.g. Pain Relief">
                </div>
                <div class="form-group">
                    <label for="medicineQuantity">Quantity</label>
                    <input type="number" id="medicineQuantity" min="0" required placeholder="e.g. 50">
                </div>
                <div class="form-actions">
                    <button type="button" class="modal-btn cancel" id="cancelModalBtn">Cancel</button>
                    <button type="submit" class="modal-btn save">Save Medicine</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { getMedicines, addMedicine, updateMedicine, deleteMedicine } from './js/medicinesService.js';
        import { supabase } from './js/supabaseClient.js';
        import { updateUIBasedOnAuth, setupLogout } from './js/common.js';
        
        const searchInput = document.getElementById('searchInput');
        const medicinesGrid = document.getElementById('medicinesGrid');
        const addMedicineBtn = document.getElementById('addMedicineBtn');
        const medicineModal = document.getElementById('medicineModal');
        const medicineForm = document.getElementById('medicineForm');
        const modalTitle = document.getElementById('modalTitle');
        const medicineIdField = document.getElementById('medicineId');
        const medicineNameField = document.getElementById('medicineName');
        const medicineCategoryField = document.getElementById('medicineCategory');
        const medicineQuantityField = document.getElementById('medicineQuantity');
        const cancelModalBtn = document.getElementById('cancelModalBtn');

        // Initialize medicines array
        let medicines = [];
        
        // Load medicines from Supabase
        async function loadMedicines() {
            try {
                medicines = await getMedicines();
                renderMedicines();
            } catch (error) {
                console.error('Error loading medicines:', error);
                alert('Error loading medicines. Please try again.');
            }
        }

        function getStatusInfo(quantity) {
            return quantity <= 15
                ? { label: 'Low Stock', className: 'status-low' }
                : { label: 'In Stock', className: 'status-stock' };
        }

        function medicineCardTemplate(med) {
            const { label, className } = getStatusInfo(med.quantity);
            return `
                <article class="medicine-card" data-id="${med.id}">
                    <div class="medicine-header">
                        <div class="medicine-info">
                            <div class="medicine-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M8.5 13.5l7-7" />
                                    <path d="M19 11a4 4 0 00-5.66-5.66L5 13.66A4 4 0 0010.66 19l8.34-8z" />
                                </svg>
                            </div>
                            <div>
                                <p class="medicine-name">${med.name}</p>
                                <p class="medicine-category">${med.category}</p>
                            </div>
                        </div>
                        <div class="quantity">
                            <span>Qty: </span>
                            <button class="quantity-btn" data-action="decrease">-</button>
                            <span class="quantity-value">${med.quantity}</span>
                            <button class="quantity-btn" data-action="increase">+</button>
                        </div>
                    </div>
                    <div class="medicine-status ${className}">${label}</div>
                    <div class="medicine-actions">
                        <button class="action-pill edit" data-action="edit">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16.862 3.487a2.11 2.11 0 112.98 2.98L6.5 19.81 3 21l1.19-3.5 12.672-13.013z" />
                            </svg>
                            Edit
                        </button>
                        <button class="action-pill delete" data-action="delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 7L18 20.5a2 2 0 01-2 1.5H8a2 2 0 01-2-1.5L5 7" />
                                <path d="M10 11v6" />
                                <path d="M14 11v6" />
                                <path d="M4 7h16" />
                                <path d="M9 4h6l1 3H8l1-3z" />
                            </svg>
                            Delete
                        </button>
                    </div>
                </article>
            `;
        }

        function renderMedicines(list = medicines) {
            medicinesGrid.innerHTML = list.map(medicineCardTemplate).join('');
            if (!list.length) {
                medicinesGrid.innerHTML = '<p style="color:#94a3b8;text-align:center;">No medicines available.</p>';
            }
        }
        
        async function saveMedicines() {
            // This function is now handled by the service functions
            // Each operation (add, update, delete) will directly call the Supabase service
        }

        function openModal(mode, medicine = null) {
            medicineModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (mode === 'edit' && medicine) {
                modalTitle.textContent = 'Edit Medicine';
                medicineIdField.value = medicine.id;
                medicineNameField.value = medicine.name;
                medicineCategoryField.value = medicine.category;
                medicineQuantityField.value = medicine.quantity;
            } else {
                modalTitle.textContent = 'Add Medicine';
                medicineIdField.value = '';
                medicineNameField.value = '';
                medicineCategoryField.value = '';
                medicineQuantityField.value = '';
            }
            medicineNameField.focus();
        }

        function closeModal() {
            medicineModal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        searchInput.addEventListener('input', function () {
            const term = this.value.trim().toLowerCase();
            const filtered = medicines.filter(
                med =>
                    med.name.toLowerCase().includes(term) ||
                    med.category.toLowerCase().includes(term)
            );
            renderMedicines(filtered);
        });

        addMedicineBtn.addEventListener('click', () => {
            openModal('add');
        });

        cancelModalBtn.addEventListener('click', closeModal);

        medicineForm.addEventListener('submit', async event => {
            event.preventDefault();
            const id = medicineIdField.value;
            const name = medicineNameField.value.trim();
            const category = medicineCategoryField.value.trim();
            const quantity = parseInt(medicineQuantityField.value, 10);
            if (!name || !category || Number.isNaN(quantity)) {
                return;
            }

            try {
                if (id) {
                    // Update existing medicine
                    const result = await updateMedicine(id, {
                        name: name,
                        category: category,
                        quantity: quantity
                    });
                    
                    if (result) {
                        // Find and update the medicine in the local array
                        const index = medicines.findIndex(item => item.id === id);
                        if (index !== -1) {
                            medicines[index] = result;
                        }
                        alert('Medicine updated successfully!');
                    } else {
                        alert('Error updating medicine. Please try again.');
                        return;
                    }
                } else {
                    // Add new medicine
                    const newMedicine = await addMedicine({
                        name: name,
                        category: category,
                        quantity: quantity
                    });
                    
                    if (newMedicine) {
                        medicines.push(newMedicine);
                        alert('Medicine added successfully!');
                    } else {
                        alert('Error adding medicine. Please try again.');
                        return;
                    }
                }
                
                // Refresh the medicine list
                renderMedicines();
                closeModal();
            } catch (error) {
                console.error('Error saving medicine:', error);
                alert('Error saving medicine. Please try again.');
            }
        });

        medicinesGrid.addEventListener('click', async (event) => {
            // Handle quantity adjustment buttons
            const quantityBtn = event.target.closest('.quantity-btn');
            if (quantityBtn) {
                const card = quantityBtn.closest('.medicine-card');
                const medId = card.dataset.id;
                const medicine = medicines.find(item => item.id === medId);
                if (!medicine) return;
                
                const action = quantityBtn.dataset.action;
                let newQuantity;
                
                if (action === 'increase') {
                    newQuantity = medicine.quantity + 1;
                } else if (action === 'decrease') {
                    newQuantity = Math.max(0, medicine.quantity - 1); // Prevent negative quantities
                }
                
                try {
                    const result = await updateMedicine(medId, { quantity: newQuantity });
                    if (result) {
                        // Update the medicine in the local array
                        const index = medicines.findIndex(item => item.id === medId);
                        if (index !== -1) {
                            medicines[index] = result;
                        }
                        
                        // Update the displayed quantity
                        const quantityValue = card.querySelector('.quantity-value');
                        if (quantityValue) {
                            quantityValue.textContent = result.quantity;
                        }
                        
                        // Update status badge if needed
                        const { label, className } = getStatusInfo(result.quantity);
                        const statusElement = card.querySelector('.medicine-status');
                        if (statusElement) {
                            statusElement.textContent = label;
                            statusElement.className = `medicine-status ${className}`;
                        }
                    } else {
                        alert('Error updating quantity. Please try again.');
                    }
                } catch (error) {
                    console.error('Error updating quantity:', error);
                    alert('Error updating quantity. Please try again.');
                }
                return;
            }
            
            // Handle action pill buttons
            const button = event.target.closest('.action-pill');
            if (!button) return;
            const card = button.closest('.medicine-card');
            const medId = card.dataset.id;
            const medicine = medicines.find(item => item.id === medId);
            if (!medicine) return;

            button.style.transform = 'translateY(-1px)';
            setTimeout(() => (button.style.transform = ''), 200);

            const action = button.dataset.action;

            if (action === 'edit') {
                openModal('edit', medicine);
                return;
            }

            if (action === 'delete') {
                if (!window.confirm(`Delete ${medicine.name}?`)) return;
                try {
                    const success = await deleteMedicine(medId);
                    if (success) {
                        // Remove from local array
                        const index = medicines.findIndex(item => item.id === medId);
                        if (index !== -1) {
                            medicines.splice(index, 1);
                        }
                        renderMedicines();
                        alert('Medicine deleted successfully!');
                    } else {
                        alert('Error deleting medicine. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting medicine:', error);
                    alert('Error deleting medicine. Please try again.');
                }
            }
        });

        // Mobile menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const adminMobileMenuToggle = document.getElementById('adminMobileMenuToggle');
            const adminSidebarNav = document.getElementById('adminSidebarNav');
            
            if (adminMobileMenuToggle && adminSidebarNav) {
                adminMobileMenuToggle.addEventListener('click', function() {
                    adminSidebarNav.classList.toggle('active');
                });
                
                const navLinks = adminSidebarNav.querySelectorAll('a');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        adminSidebarNav.classList.remove('active');
                    });
                });
                
                document.addEventListener('click', function(event) {
                    if (!adminSidebarNav.contains(event.target) && !adminMobileMenuToggle.contains(event.target)) {
                        adminSidebarNav.classList.remove('active');
                    }
                });
            }
        });

        // Check admin access and load medicines when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check if admin is logged in using Supabase auth
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError || !session || !session.user) {
                    // Not logged in - redirect to admin login
                    window.location.href = 'AdminLogin.html';
                    return;
                }
                
                // Check if user is admin by checking user type in our users table
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('type') 
                    .eq('id', session.user.id)
                    .single();
                
                if (userError || !user || user.type !== 'admin') {
                    // Not an admin - redirect to home
                    window.location.href = 'Home.html';
                    return;
                }
                
                // Update UI based on auth state
                await updateUIBasedOnAuth();
                setupLogout();
                
                await loadMedicines();
            } catch (error) {
                console.error('Error checking admin access:', error);
                window.location.href = 'AdminLogin.html';
                return;
            }
        });
    </script>
</body>
</html>